* blame-reveal.el

Contextual Git blame for Emacs with smart commit selection, recursive history navigation, and focus mode.

#+begin_quote
Show only what matters—recent commits in visible lines.
#+end_quote

[[file:assets/recent-commits.jpg]]

** Core Features

*** Smart Rendering

Only renders the viewport with margins, ensuring instant activation and smooth scrolling on large files (10k+ lines). Fringe colors follow IntelliJ IDEA style: newest commits are brightest.

*** Three Header Styles

- =block= — Header above the first line of each commit block
- =inline= — Compact header after the first line
- =margin= — In left/right window margin (minimal intrusion)

*** Time-Based Commit Selection

=blame-reveal-recent-days-limit= controls which commits get colored:

| Value   | Behavior                                              |
|---------+-------------------------------------------------------|
| ='auto= | Adapts to commit density for optimal gradient quality |
| number  | Fixed days (30, 90, 180, 365, etc.)                   |
| =nil=   | All commits with relative coloring                    |

*** Gradient Quality Control

When using ='auto= days limit, =blame-reveal-gradient-quality= tunes the balance:

| Mode      | Commits | Color Step | Use Case          |
|-----------+---------+------------+-------------------|
| =strict=  | 5-10    | 3-5%       | Best distinction  |
| =auto=    | 10-20   | 2-3%       | Balanced          |
| =relaxed= | 15-30   | 1.5-2%     | More history      |

*** Recursive Blame & Focus Mode

Navigate line history through parent commits (=b=), or lock onto a single commit to see all its modifications across the file (=F=).

** Installation

#+begin_src elisp
(use-package blame-reveal
  :load-path "/path/to/blame-reveal"
  :commands blame-reveal-mode
  :config
  ;; Optional: recursive blame and focus mode
  (require 'blame-reveal-recursive)
  (require 'blame-reveal-focus)
  ;; Optional: transient menu (requires transient package)
  (require 'blame-reveal-transient))
#+end_src

** Quick Start

#+begin_src elisp
M-x blame-reveal-mode
#+end_src

** Keybindings

| Key   | Action                      |
|-------+-----------------------------|
| =q=   | Toggle mode                 |
| =m=   | Open transient menu         |
| =c=   | Copy commit hash            |
| =d=   | Show commit diff            |
| =s=   | Show commit details         |
| =h=   | File history                |
| =l=   | Line history                |
| =b=   | Blame parent (recursive)    |
| =p= / =^= | Go back in blame stack  |
| =g=   | Blame at specific revision  |
| =r=   | Reset to HEAD               |
| =F=   | Toggle focus mode           |
| =n= / =N= | Navigate focus blocks   |

** Configuration

*** Recommended Setup

#+begin_src elisp
(setq blame-reveal-recent-days-limit 'auto
      blame-reveal-gradient-quality 'auto
      blame-reveal-header-style 'block
      blame-reveal-show-uncommitted-fringe nil)  ; Use with diff-hl
#+end_src

*** Display Options

#+begin_src elisp
;; Header style
(setq blame-reveal-header-style 'block)   ; or 'inline, 'margin

;; Fringe side
(setq blame-reveal-fringe-side 'left-fringe)  ; or 'right-fringe

;; Margin side (when header-style is 'margin)
(setq blame-reveal-margin-side 'left)  ; or 'right
#+end_src

*** Color Scheme

#+begin_src elisp
;; Default blue
(setq blame-reveal-color-scheme
      '(:hue 210
        :dark-newest 0.70 :dark-oldest 0.35
        :light-newest 0.45 :light-oldest 0.75
        :saturation-min 0.25 :saturation-max 0.60))

;; Or use presets via transient menu: blue, green, purple, orange, subtle, vivid
#+end_src

*** Performance

#+begin_src elisp
;; Async loading
(setq blame-reveal-async-blame 'auto)  ; 'auto, t, or nil

;; Lazy loading threshold (lines)
(setq blame-reveal-lazy-load-threshold 3000)
#+end_src

*** Custom Formatters

Each header style has a customizable format function:

#+begin_src elisp
;; Block header format
(setq blame-reveal-block-format-function #'my-block-formatter)

;; Inline header format
(setq blame-reveal-inline-format-function #'my-inline-formatter)

;; Margin header format
(setq blame-reveal-margin-format-function #'my-margin-formatter)
#+end_src

Format functions receive =(commit-hash commit-info color)= and return a =blame-reveal-commit-display= struct.

** Transient Menu

Press =m= in blame-reveal-mode to open the configuration menu:

- Toggle settings in real-time
- Switch header/fringe/margin styles
- Adjust color scheme with presets or fine-tuning
- Enable move/copy detection (=-M -C -C= flags)
- View auto-calculation diagnostics

** Modules

| Module                    | Purpose                              |
|---------------------------+--------------------------------------|
| =blame-reveal=            | Main entry, mode definition          |
| =blame-reveal-core=       | Data structures, state machine       |
| =blame-reveal-git=        | Git operations, blame parsing        |
| =blame-reveal-color=      | Color strategy, gradient calculation |
| =blame-reveal-header=     | Header rendering (block/inline/margin) |
| =blame-reveal-ui=         | Overlay management, animations       |
| =blame-reveal-recursive=  | Recursive blame navigation           |
| =blame-reveal-focus=      | Commit focus mode                    |
| =blame-reveal-transient=  | Configuration menu                   |

** Global Mode

Enable automatically for all git-tracked files:

#+begin_src elisp
(blame-reveal-global-mode 1)
#+end_src

** Troubleshooting

| Issue               | Solution                               |
|---------------------+----------------------------------------|
| Colors too similar  | Use =strict= quality or fewer days     |
| Too few commits     | Use =relaxed= or set fixed days        |
| Slow on large files | Enable async: =(setq blame-reveal-async-blame t)= |
| Scroll lag          | Lower =lazy-load-threshold=            |

Use =M-x blame-reveal-show-auto-calculation= to see how the time window is computed.

** Requirements

- Emacs 27.1+
- Git CLI
- Optional: Magit, diff-hl, nerd-icons, transient

** License

GPL-3.0-or-later
